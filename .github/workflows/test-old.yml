name: Test
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  code-quality:
    name: "Code Quality & Validation"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      - name: Set GCP Project
        run: echo "GOOGLE_CLOUD_PROJECT=rl-prod-471116" >> $GITHUB_ENV
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          check-latest: false
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt ruff pytest pytest-mock psycopg2-binary
      - name: Run linting
        continue-on-error: true
        run: |
          echo "üîç Running linting checks..."
          if python3 -m ruff check src/ --line-length 120; then
            echo "‚úÖ Linting passed - no issues found"
          else
            echo "‚ö†Ô∏è Linting found issues - continuing with tests"
            echo "üí° Please review and fix linting issues when possible"
          fi
      - name: Run validation tests
        env:
          PYTHONPATH: .
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TEXT_CHANNEL_ID: ${{ secrets.TEXT_CHANNEL_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_CLOUD_PROJECT: rl-prod-471116
        run: |
          echo "‚úÖ Running validation tests..."
          python3 -m pytest tests/test_validation.py -v
          echo "‚úÖ Validation tests completed!"

  database-architecture:
    name: "Database Architecture Tests"
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      - name: Set GCP Project
        run: echo "GOOGLE_CLOUD_PROJECT=rl-prod-471116" >> $GITHUB_ENV
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          check-latest: false
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt ruff pytest pytest-mock psycopg2-binary
      - name: Test Database v2.0.0 Architecture
        env:
          PYTHONPATH: .
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TEXT_CHANNEL_ID: ${{ secrets.TEXT_CHANNEL_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_CLOUD_PROJECT: rl-prod-471116
        run: |
          echo "üóÑÔ∏è Testing Database Architecture v2.0.0..."
          python3 -m pytest tests/test_database_v2.py -v
          echo "‚úÖ Database v2.0.0 tests completed!"
      - name: Test Database Integration
        env:
          PYTHONPATH: .
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TEXT_CHANNEL_ID: ${{ secrets.TEXT_CHANNEL_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_CLOUD_PROJECT: rl-prod-471116
        run: |
          echo "üîó Testing Database Integration..."
          python3 -m pytest tests/test_database_integration.py -v
          echo "‚úÖ Database integration tests completed!"
      - name: Test Database Performance
        env:
          PYTHONPATH: .
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TEXT_CHANNEL_ID: ${{ secrets.TEXT_CHANNEL_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_CLOUD_PROJECT: rl-prod-471116
        run: |
          echo "‚ö° Testing Database Performance..."
          python3 -m pytest tests/test_database_performance.py -v
          echo "‚úÖ Database performance tests completed!"

  bot-functionality:
    name: "Bot Functionality Tests" 
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      - name: Set GCP Project
        run: echo "GOOGLE_CLOUD_PROJECT=rl-prod-471116" >> $GITHUB_ENV
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          check-latest: false
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt ruff pytest pytest-mock psycopg2-binary
      - name: Test Participation Bot
        env:
          PYTHONPATH: .
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TEXT_CHANNEL_ID: ${{ secrets.TEXT_CHANNEL_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_CLOUD_PROJECT: rl-prod-471116
        run: |
          echo "ü§ñ Testing Participation Bot..."
          python3 -m pytest tests/test_participation_bot.py -v
          echo "‚úÖ Participation bot tests completed!"
      - name: Test Modular System
        env:
          PYTHONPATH: .
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TEXT_CHANNEL_ID: ${{ secrets.TEXT_CHANNEL_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_CLOUD_PROJECT: rl-prod-471116
        run: |
          echo "üß© Testing Modular System Architecture..."
          python3 -m pytest tests/test_modular_system.py -v
          echo "‚úÖ Modular system tests completed!"

  advanced-system:
    name: "Advanced System Tests"
    runs-on: ubuntu-latest
    needs: [database-architecture, bot-functionality]
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      - name: Set GCP Project
        run: echo "GOOGLE_CLOUD_PROJECT=rl-prod-471116" >> $GITHUB_ENV
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          check-latest: false
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt ruff pytest pytest-mock psycopg2-binary
      - name: Test Advanced System Components
        env:
          PYTHONPATH: .
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TEXT_CHANNEL_ID: ${{ secrets.TEXT_CHANNEL_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_CLOUD_PROJECT: rl-prod-471116
        run: |
          echo "üöÄ Testing Advanced System Components..."
          python3 -m pytest tests/test_advanced_system.py -v
          echo "‚úÖ Advanced system tests completed!"

  test-summary:
    name: "Test Summary & Results"
    runs-on: ubuntu-latest
    needs: [code-quality, database-architecture, bot-functionality, advanced-system]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Generate Test Summary
        run: |
          echo "üìä **Test Suite Results Summary**" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY  
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality & Validation | ${{ needs.code-quality.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database Architecture Tests | ${{ needs.database-architecture.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bot Functionality Tests | ${{ needs.bot-functionality.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Advanced System Tests | ${{ needs.advanced-system.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          # Overall result
          if [ "${{ needs.code-quality.result }}" = "success" ] && [ "${{ needs.database-architecture.result }}" = "success" ] && [ "${{ needs.bot-functionality.result }}" = "success" ] && [ "${{ needs.advanced-system.result }}" = "success" ]; then
            echo "## üéâ All tests passed! Ready for deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ö†Ô∏è Some tests failed - review results above" >> $GITHUB_STEP_SUMMARY
          fi
  # Post-test actions for label management
  post-tests:
    name: "Post-Test Actions"
    runs-on: ubuntu-latest
    needs: [code-quality, database-architecture, bot-functionality, advanced-system]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update PR labels based on test results
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request?.number;
            
            if (!pull_number) {
              console.log('Not a pull request, skipping label updates');
              return;
            }

            // Check test results
            const codeQuality = '${{ needs.code-quality.result }}';
            const dbArchitecture = '${{ needs.database-architecture.result }}';
            const botFunctionality = '${{ needs.bot-functionality.result }}';
            const advancedSystem = '${{ needs.advanced-system.result }}';
            
            const allTestsPassed = codeQuality === 'success' && 
                                 dbArchitecture === 'success' && 
                                 botFunctionality === 'success' && 
                                 advancedSystem === 'success';
            
            // Remove old test labels
            const labelsToRemove = ['tests pending', 'tests failed'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: pull_number,
                  name: label
                });
              } catch (error) {
                console.log(`Label "${label}" not found, skipping removal`);
              }
            }
            
            // Add appropriate label based on results
            if (allTestsPassed) {
              await github.rest.issues.addLabelsToIssue({
                owner,
                repo,
                issue_number: pull_number,
                labels: ['tests good']
              });
              
              // Add comment with success summary
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: "## ‚úÖ All Tests Passed!\n\n| Test Suite | Result |\n|------------|--------|\n| Code Quality & Validation | ‚úÖ Passed |\n| Database Architecture v2.0.0 | ‚úÖ Passed |\n| Bot Functionality | ‚úÖ Passed |\n| Advanced System Components | ‚úÖ Passed |\n\nüöÄ **Ready for deployment!** Add the `deploy` label when ready to deploy to staging."
              });
            } else {
              await github.rest.issues.addLabelsToIssue({
                owner,
                repo,
                issue_number: pull_number,
                labels: ['tests failed']
              });
              
              // Add comment with failure details
              const failedTests = [];
              if (codeQuality !== 'success') failedTests.push('Code Quality & Validation');
              if (dbArchitecture !== 'success') failedTests.push('Database Architecture');
              if (botFunctionality !== 'success') failedTests.push('Bot Functionality');
              if (advancedSystem !== 'success') failedTests.push('Advanced System');
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: "## ‚ùå Some Tests Failed\\n\\n| Test Suite | Result |\\n|------------|--------|\\n| Code Quality & Validation | " + (codeQuality === 'success' ? '‚úÖ Passed' : '‚ùå Failed') + " |\\n| Database Architecture v2.0.0 | " + (dbArchitecture === 'success' ? '‚úÖ Passed' : '‚ùå Failed') + " |\\n| Bot Functionality | " + (botFunctionality === 'success' ? '‚úÖ Passed' : '‚ùå Failed') + " |\\n| Advanced System Components | " + (advancedSystem === 'success' ? '‚úÖ Passed' : '‚ùå Failed') + " |\\n\\n**Failed test suites:** " + failedTests.join(', ') + "\\n\\nPlease review the test results and fix any issues before proceeding."
              });
            }
          python-version: '3.9'
          check-latest: false
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt pytest psycopg2-binary
      - name: Test Database Architecture v2.0.0
        env:
          PYTHONPATH: .
        run: |
          echo "üß™ Testing Database Architecture v2.0.0..."
          python3 tests/test_database_integration.py
          echo "‚úÖ Database architecture tests completed!"

  post-test:
    if: always()  # Run regardless of test job success/failure
    needs: [code-quality, test-modular-architecture, test-advanced-components, test-final-validation, test-connections, test-ansible-deployment, test-database-architecture]
    runs-on: ubuntu-latest
    steps:
      - name: Add Tests Good Label on Success
        if: needs.code-quality.result == 'success' && needs.test-modular-architecture.result == 'success' && needs.test-advanced-components.result == 'success' && needs.test-final-validation.result == 'success' && needs.test-connections.result == 'success' && (needs.test-ansible-deployment.result == 'success' || needs.test-ansible-deployment.outputs.result == 'syntax-valid') && needs.test-database-architecture.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Remove any existing labels from previous runs
              const labelsToRemove = ['bug', 'deploy', 'ready to merge'];
              for (const label of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    name: label
                  });
                  console.log(`${label} label removed successfully`);
                } catch (error) {
                  if (error.status === 404) {
                    console.log(`${label} label not found, nothing to remove`);
                  } else {
                    console.error(`Failed to remove ${label} label:`, error.message);
                  }
                }
              }
              
              // Add Tests Good label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['tests good']
              });
              console.log('Tests Good label added successfully');
              
              // Remove bug label if it exists
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: 'bug'
                });
                console.log('Bug label removed successfully');
              } catch (error) {
                if (error.status === 404) {
                  console.log('Bug label not found, nothing to remove');
                } else {
                  console.error('Failed to remove bug label:', error.message);
                }
              }
            } catch (error) {
              console.error('Failed to add Ready to Deploy label:', error.message);
              throw error;
            }
      
      - name: Add Bug Label on Failure
        if: needs.code-quality.result == 'failure' || needs.test-modular-architecture.result == 'failure' || needs.test-advanced-components.result == 'failure' || needs.test-final-validation.result == 'failure' || needs.test-connections.result == 'failure' || (needs.test-ansible-deployment.result == 'failure' && needs.test-ansible-deployment.outputs.result == 'fail')
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Add bug label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['bug']
              });
              console.log('Bug label added successfully');
              
              // Remove Ready to Deploy label if it exists
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: 'Ready to Deploy'
                });
                console.log('Ready to Deploy label removed successfully');
              } catch (error) {
                if (error.status === 404) {
                  console.log('Ready to Deploy label not found, nothing to remove');
                } else {
                  console.error('Failed to remove Ready to Deploy label:', error.message);
                }
              }
            } catch (error) {
              console.error('Failed to add Tests Good label:', error.message);
              throw error;
            }
      
      - name: Add Bug Label on Test Failure
        if: needs.code-quality.result == 'failure' || needs.test-modular-architecture.result == 'failure' || needs.test-advanced-components.result == 'failure' || needs.test-final-validation.result == 'failure' || needs.test-connections.result == 'failure' || (needs.test-ansible-deployment.result == 'failure' && needs.test-ansible-deployment.outputs.result != 'syntax-valid') || needs.test-database-architecture.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Remove any existing workflow labels
              const labelsToRemove = ['tests good', 'deploy', 'ready to merge'];
              for (const label of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    name: label
                  });
                  console.log(`${label} label removed successfully`);
                } catch (error) {
                  if (error.status === 404) {
                    console.log(`${label} label not found, nothing to remove`);
                  } else {
                    console.error(`Failed to remove ${label} label:`, error.message);
                  }
                }
              }
              
              // Add Bug label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['bug']
              });
              console.log('Bug label added successfully');
              
              // Add comment explaining test failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '‚ùå **Tests Failed**\\n\\nOne or more tests failed. Please review the test results above and fix any issues before proceeding with deployment.\\n\\nOnce fixed, push new changes to re-run the tests.'
              });
            } catch (error) {
              console.error('Failed to add bug label:', error.message);
            }