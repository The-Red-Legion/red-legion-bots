2025-09-07T16:10:06.3257626Z ##[group]Run echo "=== Discord Bot Health Check ==="
2025-09-07T16:10:06.3258321Z [36;1mecho "=== Discord Bot Health Check ==="[0m
2025-09-07T16:10:06.3258827Z [36;1m[0m
2025-09-07T16:10:06.3259284Z [36;1m# Function to check if bot responds to Discord[0m
2025-09-07T16:10:06.3259841Z [36;1mcheck_discord_health() ***[0m
2025-09-07T16:10:06.3260334Z [36;1m  local max_attempts=3[0m
2025-09-07T16:10:06.3260790Z [36;1m  local attempt=1[0m
2025-09-07T16:10:06.3261217Z [36;1m  [0m
2025-09-07T16:10:06.3261661Z [36;1m  while [ $attempt -le $max_attempts ]; do[0m
2025-09-07T16:10:06.3262275Z [36;1m    echo "Health check attempt $attempt/$max_attempts..."[0m
2025-09-07T16:10:06.3263044Z [36;1m    [0m
2025-09-07T16:10:06.3263563Z [36;1m    # Send a test message to Discord and check if bot processes it[0m
2025-09-07T16:10:06.3264210Z [36;1m    # Using a simple API call to check if bot is online[0m
2025-09-07T16:10:06.3264771Z [36;1m    HEALTH_CHECK=$(curl -s -X GET \[0m
2025-09-07T16:10:06.3265392Z [36;1m      "https://discord.com/api/v10/applications/@me" \[0m
2025-09-07T16:10:06.3266218Z [36;1m      -H "Authorization: Bot ***" \[0m
2025-09-07T16:10:06.3266746Z [36;1m      -H "Content-Type: application/json")[0m
2025-09-07T16:10:06.3267245Z [36;1m    [0m
2025-09-07T16:10:06.3267695Z [36;1m    if echo "$HEALTH_CHECK" | grep -q '"id"'; then[0m
2025-09-07T16:10:06.3268328Z [36;1m      echo "✅ Bot is authenticated and responding to Discord API"[0m
2025-09-07T16:10:06.3268888Z [36;1m      [0m
2025-09-07T16:10:06.3269395Z [36;1m      # Additional check: verify bot can access guild information[0m
2025-09-07T16:10:06.3269975Z [36;1m      GUILD_CHECK=$(curl -s -X GET \[0m
2025-09-07T16:10:06.3270543Z [36;1m        "https://discord.com/api/v10/users/@me/guilds" \[0m
2025-09-07T16:10:06.3271359Z [36;1m        -H "Authorization: Bot ***" \[0m
2025-09-07T16:10:06.3271891Z [36;1m        -H "Content-Type: application/json")[0m
2025-09-07T16:10:06.3272569Z [36;1m      [0m
2025-09-07T16:10:06.3273051Z [36;1m      if echo "$GUILD_CHECK" | grep -q '\[.*\]'; then[0m
2025-09-07T16:10:06.3273614Z [36;1m        echo "✅ Bot can access guild information"[0m
2025-09-07T16:10:06.3274167Z [36;1m        echo "✅ Discord health check PASSED"[0m
2025-09-07T16:10:06.3274672Z [36;1m        return 0[0m
2025-09-07T16:10:06.3275091Z [36;1m      else[0m
2025-09-07T16:10:06.3275589Z [36;1m        echo "⚠️ Bot authenticated but cannot access guilds"[0m
2025-09-07T16:10:06.3276119Z [36;1m      fi[0m
2025-09-07T16:10:06.3276514Z [36;1m    else[0m
2025-09-07T16:10:06.3276963Z [36;1m      echo "❌ Bot not responding to Discord API"[0m
2025-09-07T16:10:06.3277477Z [36;1m    fi[0m
2025-09-07T16:10:06.3277874Z [36;1m    [0m
2025-09-07T16:10:06.3278322Z [36;1m    echo "Waiting 10 seconds before retry..."[0m
2025-09-07T16:10:06.3278836Z [36;1m    sleep 10[0m
2025-09-07T16:10:06.3279273Z [36;1m    attempt=$((attempt + 1))[0m
2025-09-07T16:10:06.3279924Z [36;1m  done[0m
2025-09-07T16:10:06.3280313Z [36;1m  [0m
2025-09-07T16:10:06.3280833Z [36;1m  echo "❌ Discord health check FAILED after $max_attempts attempts"[0m
2025-09-07T16:10:06.3281400Z [36;1m  return 1[0m
2025-09-07T16:10:06.3281817Z [36;1m***[0m
2025-09-07T16:10:06.3282200Z [36;1m[0m
2025-09-07T16:10:06.3282817Z [36;1m# Also check if process exists (supplementary check)[0m
2025-09-07T16:10:06.3283387Z [36;1mecho "=== Process Status Check ==="[0m
2025-09-07T16:10:06.3283895Z [36;1mif [ -f "/app/bot.pid" ]; then[0m
2025-09-07T16:10:06.3284392Z [36;1m  PID=$(cat /app/bot.pid)[0m
2025-09-07T16:10:06.3284887Z [36;1m  echo "Found PID file with PID: $PID"[0m
2025-09-07T16:10:06.3285367Z [36;1m  [0m
2025-09-07T16:10:06.3285798Z [36;1m  if ps -p "$PID" > /dev/null 2>&1; then[0m
2025-09-07T16:10:06.3286342Z [36;1m    echo "✅ Bot process is running (PID: $PID)"[0m
2025-09-07T16:10:06.3286876Z [36;1m    PROCESS_STATUS="running"[0m
2025-09-07T16:10:06.3287356Z [36;1m  else[0m
2025-09-07T16:10:06.3287864Z [36;1m    echo "⚠️ Bot process not found, but this may be a false negative"[0m
2025-09-07T16:10:06.3288636Z [36;1m    PROCESS_STATUS="unknown"[0m
2025-09-07T16:10:06.3289116Z [36;1m  fi[0m
2025-09-07T16:10:06.3289506Z [36;1melse[0m
2025-09-07T16:10:06.3289958Z [36;1m  echo "⚠️ No PID file found at /app/bot.pid"[0m
2025-09-07T16:10:06.3290491Z [36;1m  PROCESS_STATUS="no_pid"[0m
2025-09-07T16:10:06.3290947Z [36;1mfi[0m
2025-09-07T16:10:06.3291339Z [36;1m[0m
2025-09-07T16:10:06.3291748Z [36;1m# Check recent bot logs for activity[0m
2025-09-07T16:10:06.3292265Z [36;1mecho "=== Bot Log Analysis ==="[0m
2025-09-07T16:10:06.3292924Z [36;1mif [ -f "/app/bot.log" ]; then[0m
2025-09-07T16:10:06.3293425Z [36;1m  echo "Recent bot log entries:"[0m
2025-09-07T16:10:06.3293915Z [36;1m  tail -10 /app/bot.log[0m
2025-09-07T16:10:06.3294360Z [36;1m  [0m
2025-09-07T16:10:06.3294800Z [36;1m  # Check for recent heartbeat messages[0m
2025-09-07T16:10:06.3295410Z [36;1m  if grep -q "Heartbeat: Bot is still running" /app/bot.log; then[0m
2025-09-07T16:10:06.3296150Z [36;1m    LAST_HEARTBEAT=$(grep "Heartbeat: Bot is still running" /app/bot.log | tail -1)[0m
2025-09-07T16:10:06.3296805Z [36;1m    echo "✅ Found heartbeat: $LAST_HEARTBEAT"[0m
2025-09-07T16:10:06.3297304Z [36;1m  else[0m
2025-09-07T16:10:06.3297760Z [36;1m    echo "⚠️ No recent heartbeat messages found"[0m
2025-09-07T16:10:06.3298268Z [36;1m  fi[0m
2025-09-07T16:10:06.3298649Z [36;1m  [0m
2025-09-07T16:10:06.3299063Z [36;1m  # Check for errors in recent logs[0m
2025-09-07T16:10:06.3299684Z [36;1m  if tail -20 /app/bot.log | grep -i "error\|exception\|failed" > /dev/null; then[0m
2025-09-07T16:10:06.3300315Z [36;1m    echo "⚠️ Recent errors found in logs:"[0m
2025-09-07T16:10:06.3300908Z [36;1m    tail -20 /app/bot.log | grep -i "error\|exception\|failed"[0m
2025-09-07T16:10:06.3301448Z [36;1m  else[0m
2025-09-07T16:10:06.3301882Z [36;1m    echo "✅ No recent errors in bot logs"[0m
2025-09-07T16:10:06.3302591Z [36;1m  fi[0m
2025-09-07T16:10:06.3302997Z [36;1melse[0m
2025-09-07T16:10:06.3303411Z [36;1m  echo "⚠️ No bot log file found"[0m
2025-09-07T16:10:06.3303880Z [36;1mfi[0m
2025-09-07T16:10:06.3304268Z [36;1m[0m
2025-09-07T16:10:06.3304705Z [36;1m# Primary health check: Discord API response[0m
2025-09-07T16:10:06.3305231Z [36;1mif check_discord_health; then[0m
2025-09-07T16:10:06.3305702Z [36;1m  echo ""[0m
2025-09-07T16:10:06.3306142Z [36;1m  echo "🎉 === HEALTH CHECK SUMMARY ==="[0m
2025-09-07T16:10:06.3306704Z [36;1m  echo "✅ PRIMARY: Discord API health check PASSED"[0m
2025-09-07T16:10:06.3307272Z [36;1m  echo "ℹ️  Process status: $PROCESS_STATUS"[0m
2025-09-07T16:10:06.3307862Z [36;1m  echo "✅ Bot is confirmed working and responding to Discord"[0m
2025-09-07T16:10:06.3308446Z [36;1m  echo "✅ Deployment is SUCCESSFUL"[0m
2025-09-07T16:10:06.3308923Z [36;1m  exit 0[0m
2025-09-07T16:10:06.3309325Z [36;1melse[0m
2025-09-07T16:10:06.3309712Z [36;1m  echo ""[0m
2025-09-07T16:10:06.3310287Z [36;1m  echo "❌ === HEALTH CHECK SUMMARY ==="[0m
2025-09-07T16:10:06.3310850Z [36;1m  echo "❌ PRIMARY: Discord API health check FAILED"[0m
2025-09-07T16:10:06.3311409Z [36;1m  echo "ℹ️  Process status: $PROCESS_STATUS"[0m
2025-09-07T16:10:06.3311998Z [36;1m  echo "❌ Bot may not be responding to Discord properly"[0m
2025-09-07T16:10:06.3312761Z [36;1m  echo "Check logs above for details"[0m
2025-09-07T16:10:06.3313248Z [36;1m  exit 1[0m
2025-09-07T16:10:06.3313641Z [36;1mfi[0m
2025-09-07T16:10:06.3344105Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail ***0***
2025-09-07T16:10:06.3344685Z env:
2025-09-07T16:10:06.3345345Z   DATABASE_URL: ***
2025-09-07T16:10:06.3346076Z   CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: /home/runner/work/red-legion-bots/red-legion-bots/gha-creds-710a04cc13d8758d.json
2025-09-07T16:10:06.3347127Z   GOOGLE_APPLICATION_CREDENTIALS: /home/runner/work/red-legion-bots/red-legion-bots/gha-creds-710a04cc13d8758d.json
2025-09-07T16:10:06.3348101Z   GOOGLE_GHA_CREDS_PATH: /home/runner/work/red-legion-bots/red-legion-bots/gha-creds-710a04cc13d8758d.json
2025-09-07T16:10:06.3349003Z   CLOUDSDK_CORE_PROJECT: rl-prod-471116
2025-09-07T16:10:06.3349509Z   CLOUDSDK_PROJECT: rl-prod-471116
2025-09-07T16:10:06.3349990Z   GCLOUD_PROJECT: rl-prod-471116
2025-09-07T16:10:06.3350472Z   GCP_PROJECT: rl-prod-471116
2025-09-07T16:10:06.3350939Z   GOOGLE_CLOUD_PROJECT: rl-prod-471116
2025-09-07T16:10:06.3351496Z   pythonLocation: /opt/hostedtoolcache/Python/3.9.23/x64
2025-09-07T16:10:06.3352179Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.9.23/x64/lib/pkgconfig
2025-09-07T16:10:06.3352943Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.9.23/x64
2025-09-07T16:10:06.3353546Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.9.23/x64
2025-09-07T16:10:06.3354141Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.9.23/x64
2025-09-07T16:10:06.3354736Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.9.23/x64/lib
2025-09-07T16:10:06.3355281Z ##[endgroup]
2025-09-07T16:10:06.3407359Z === Discord Bot Health Check ===
2025-09-07T16:10:06.3408624Z === Process Status Check ===
2025-09-07T16:10:06.3409593Z ⚠️ No PID file found at /app/bot.pid
2025-09-07T16:10:06.3410163Z === Bot Log Analysis ===
2025-09-07T16:10:06.3410791Z ⚠️ No bot log file found
2025-09-07T16:10:06.3411244Z Health check attempt 1/3...
2025-09-07T16:10:06.6369525Z ✅ Bot is authenticated and responding to Discord API
2025-09-07T16:10:06.9389132Z ✅ Bot can access guild information
2025-09-07T16:10:06.9390135Z ✅ Discord health check PASSED
2025-09-07T16:10:06.9390774Z 
2025-09-07T16:10:06.9391206Z 🎉 === HEALTH CHECK SUMMARY ===
2025-09-07T16:10:06.9391958Z ✅ PRIMARY: Discord API health check PASSED
2025-09-07T16:10:06.9392755Z ℹ️  Process status: no_pid
2025-09-07T16:10:06.9393320Z ✅ Bot is confirmed working and responding to Discord
2025-09-07T16:10:06.9393906Z ✅ Deployment is SUCCESSFUL
